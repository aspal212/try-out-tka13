<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tambah Peserta - Try Out TKA13</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/admin.css">
    <style>
        .form-container {
            max-width: 600px;
            margin: 2rem auto;
            padding: 2rem;
            background: white;
            border-radius: 1rem;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
        
        .form-header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e9ecef;
        }
        
        .credentials-display {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            border: 2px solid #2196f3;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin: 1.5rem 0;
        }
        
        .credentials-display h6 {
            color: #1976d2;
            margin-bottom: 1rem;
        }
        
        .credential-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 0.5rem;
        }
        
        .credential-label {
            font-weight: 600;
            color: #495057;
        }
        
        .credential-value {
            font-family: 'Courier New', monospace;
            background: #f8f9fa;
            padding: 0.25rem 0.75rem;
            border-radius: 0.25rem;
            border: 1px solid #dee2e6;
        }
        
        .success-message {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border: 2px solid #28a745;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin: 1.5rem 0;
            display: none;
        }
        
        .form-floating {
            margin-bottom: 1rem;
        }
        
        .form-floating .form-control {
            border-radius: 0.5rem;
        }
        
        .form-floating .form-control:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        }
        
        .form-floating label {
            color: #6c757d;
        }
        
        .required {
            color: #dc3545;
        }
        
        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid #dee2e6;
        }
        
        .btn-lg {
            padding: 0.75rem 2rem;
            font-weight: 600;
        }
        
        .page-header {
            background: linear-gradient(135deg, #0d6efd 0%, #6610f2 100%);
            color: white;
            padding: 3rem 0;
            margin-bottom: 2rem;
        }
        
        .breadcrumb {
            background: none;
            padding: 0;
            margin: 0;
        }
        
        .breadcrumb-item a {
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
        }
        
        .breadcrumb-item.active {
            color: white;
        }
        
        .validation-feedback {
            color: #dc3545;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
        
        .duplicate-warning {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 2px solid #ffc107;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-top: 0.5rem;
            display: none;
        }
    </style>
</head>
<body>
    <!-- Page Header -->
    <div class="page-header">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="../index.html">Beranda</a></li>
                            <li class="breadcrumb-item"><a href="dashboard.html">Admin Dashboard</a></li>
                            <li class="breadcrumb-item"><a href="participants.html">Manajemen Peserta</a></li>
                            <li class="breadcrumb-item active">Tambah Peserta</li>
                        </ol>
                    </nav>
                    <h1 class="h2 mb-0">
                        <i class="bi bi-person-plus"></i> Tambah Peserta Baru
                    </h1>
                    <p class="mb-0 opacity-75">Formulir pendaftaran peserta ujian TKA13</p>
                </div>
                <div class="col-auto">
                    <a href="participants.html" class="btn btn-light">
                        <i class="bi bi-arrow-left"></i> Kembali ke Daftar
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <div class="form-container">
            <!-- Success Message -->
            <div class="success-message" id="successMessage">
                <div class="text-center">
                    <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
                    <h5 class="text-success mt-3">Peserta Berhasil Ditambahkan!</h5>
                    <p class="mb-3">Data peserta telah tersimpan di database.</p>
                </div>
            </div>

            <!-- Form -->
            <form id="participantForm" novalidate>
                <!-- Form Header -->
                <div class="form-header">
                    <h4><i class="bi bi-person-lines-fill"></i> Data Peserta</h4>
                    <p class="text-muted mb-0">Masukkan data lengkap peserta ujian</p>
                </div>

                <!-- Nama Lengkap -->
                <div class="form-floating">
                    <input type="text" class="form-control" id="fullName" name="fullName" 
                           placeholder="Nama Lengkap" required>
                    <label for="fullName">Nama Lengkap <span class="required">*</span></label>
                    <div class="validation-feedback" id="fullNameError"></div>
                </div>

                <!-- NISN -->
                <div class="form-floating">
                    <input type="text" class="form-control" id="nisn" name="nisn" 
                           placeholder="NISN" required maxlength="10">
                    <label for="nisn">NISN (10 digit) <span class="required">*</span></label>
                    <div class="validation-feedback" id="nisnError"></div>
                    <div class="duplicate-warning" id="nisnDuplicate">
                        <i class="bi bi-exclamation-triangle"></i>
                        NISN ini sudah terdaftar. Silakan periksa kembali.
                    </div>
                </div>

                <!-- Tanggal Lahir -->
                <div class="form-floating">
                    <input type="date" class="form-control" id="birthDate" name="birthDate" 
                           placeholder="Tanggal Lahir" required>
                    <label for="birthDate">Tanggal Lahir <span class="required">*</span></label>
                    <div class="validation-feedback" id="birthDateError"></div>
                </div>

                <!-- Informasi Usia -->
                <div class="mb-3">
                    <small class="text-muted" id="ageInfo"></small>
                </div>

                <!-- Preview Credentials -->
                <div class="credentials-display" id="credentialsDisplay" style="display: none;">
                    <h6><i class="bi bi-shield-lock"></i> Akun yang Akan Dibuat</h6>
                    <div class="credential-item">
                        <span class="credential-label">Username:</span>
                        <span class="credential-value" id="previewUsername">-</span>
                    </div>
                    <div class="credential-item">
                        <span class="credential-label">Password:</span>
                        <span class="credential-value" id="previewPassword">-</span>
                    </div>
                    <div class="credential-item">
                        <span class="credential-label">ID Peserta:</span>
                        <span class="credential-value" id="previewParticipantId">-</span>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="bi bi-info-circle"></i>
                            Peserta dapat login menggunakan NISN atau username di atas
                        </small>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="form-actions">
                    <button type="button" class="btn btn-outline-secondary btn-lg" onclick="resetForm()">
                        <i class="bi bi-arrow-clockwise"></i> Reset
                    </button>
                    <button type="button" class="btn btn-outline-primary btn-lg" onclick="saveAndContinue()">
                        <i class="bi bi-save2"></i> Simpan & Tambah Lagi
                    </button>
                    <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                        <i class="bi bi-save"></i> Simpan Peserta
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="loading-content">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
            <h5 class="mt-3">Menyimpan Data...</h5>
            <p class="text-muted">Mohon tunggu sebentar</p>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        class ParticipantFormManager {
            constructor() {
                this.form = document.getElementById('participantForm');
                this.init();
            }

            init() {
                this.bindEvents();
                this.setupValidation();
                this.loadExistingData();
            }

            bindEvents() {
                // Form submission
                this.form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleSubmit();
                });

                // Real-time validation
                const inputs = ['fullName', 'nisn', 'birthDate'];
                inputs.forEach(inputId => {
                    const input = document.getElementById(inputId);
                    if (input) {
                        input.addEventListener('input', () => {
                            this.validateField(input);
                            this.updateCredentialsPreview();
                        });
                        
                        input.addEventListener('blur', () => {
                            this.validateField(input);
                            if (inputId === 'nisn') {
                                this.checkNisnDuplicate();
                            }
                        });
                    }
                });

                // NISN only numbers
                const nisnInput = document.getElementById('nisn');
                if (nisnInput) {
                    nisnInput.addEventListener('input', (e) => {
                        e.target.value = e.target.value.replace(/[^0-9]/g, '');
                    });
                }
            }

            setupValidation() {
                // Set birth date max to today
                const birthDate = document.getElementById('birthDate');
                if (birthDate) {
                    const today = new Date().toISOString().split('T')[0];
                    birthDate.setAttribute('max', today);
                }
            }

            async loadExistingData() {
                try {
                    // Load existing NISN for duplicate checking
                    const response = await axios.get('/api/participants/nisn-list');
                    this.existingNisn = response.data.map(p => p.nisn);
                } catch (error) {
                    console.error('Error loading existing data:', error);
                    this.existingNisn = [];
                }
            }

            validateField(field) {
                const value = field.value.trim();
                const fieldName = field.name;
                let isValid = true;
                let errorMessage = '';

                // Clear previous errors
                field.classList.remove('is-invalid');
                this.clearFieldError(fieldName);

                // Required validation
                if (field.hasAttribute('required') && !value) {
                    errorMessage = `${this.getFieldLabel(fieldName)} harus diisi`;
                    isValid = false;
                }

                // Specific validations
                if (isValid && value) {
                    switch (fieldName) {
                        case 'fullName':
                            if (value.length < 3) {
                                errorMessage = 'Nama minimal 3 karakter';
                                isValid = false;
                            }
                            break;
                            
                        case 'nisn':
                            if (value.length !== 10) {
                                errorMessage = 'NISN harus 10 digit';
                                isValid = false;
                            } else if (!/^\d{10}$/.test(value)) {
                                errorMessage = 'NISN hanya boleh angka';
                                isValid = false;
                            }
                            break;
                            
                        case 'birthDate':
                            const birthDate = new Date(value);
                            const today = new Date();
                            const age = today.getFullYear() - birthDate.getFullYear();
                            
                            if (age < 10 || age > 25) {
                                errorMessage = 'Usia harus antara 10-25 tahun';
                                isValid = false;
                            }
                            break;
                    }
                }

                if (!isValid) {
                    this.showFieldError(fieldName, errorMessage);
                    field.classList.add('is-invalid');
                }

                return isValid;
            }

            getFieldLabel(fieldName) {
                const labels = {
                    'fullName': 'Nama lengkap',
                    'nisn': 'NISN',
                    'birthDate': 'Tanggal lahir'
                };
                return labels[fieldName] || fieldName;
            }

            showFieldError(fieldName, message) {
                const errorElement = document.getElementById(fieldName + 'Error');
                if (errorElement) {
                    errorElement.textContent = message;
                }
            }

            clearFieldError(fieldName) {
                const errorElement = document.getElementById(fieldName + 'Error');
                if (errorElement) {
                    errorElement.textContent = '';
                }
            }

            checkNisnDuplicate() {
                const nisnInput = document.getElementById('nisn');
                const duplicateWarning = document.getElementById('nisnDuplicate');
                const nisn = nisnInput.value.trim();

                if (nisn && this.existingNisn && this.existingNisn.includes(nisn)) {
                    duplicateWarning.style.display = 'block';
                    nisnInput.classList.add('is-invalid');
                    return true;
                } else {
                    duplicateWarning.style.display = 'none';
                    nisnInput.classList.remove('is-invalid');
                    return false;
                }
            }

            updateCredentialsPreview() {
                const fullName = document.getElementById('fullName').value.trim();
                const nisn = document.getElementById('nisn').value.trim();
                const birthDate = document.getElementById('birthDate').value;

                // Update age info
                const ageInfo = document.getElementById('ageInfo');
                if (birthDate) {
                    const birth = new Date(birthDate);
                    const today = new Date();
                    const age = today.getFullYear() - birth.getFullYear();
                    ageInfo.textContent = `Usia: ${age} tahun`;
                } else {
                    ageInfo.textContent = '';
                }

                // Show credentials preview if all fields are filled
                if (fullName && nisn && nisn.length === 10 && birthDate) {
                    const credentials = this.generateCredentials(fullName, nisn, birthDate);
                    
                    document.getElementById('previewUsername').textContent = credentials.username;
                    document.getElementById('previewPassword').textContent = credentials.password;
                    document.getElementById('previewParticipantId').textContent = credentials.participantId;
                    document.getElementById('credentialsDisplay').style.display = 'block';
                } else {
                    document.getElementById('credentialsDisplay').style.display = 'none';
                }
            }

            generateCredentials(fullName, nisn, birthDate) {
                // Generate username
                const cleanName = fullName.toLowerCase().replace(/[^a-z\s]/g, '').trim();
                const nameParts = cleanName.split(/\s+/);
                let username = 'tka13_';
                
                if (nameParts.length >= 2) {
                    username += `${nameParts[0]}.${nameParts[1]}`;
                } else {
                    username += nameParts[0] || 'user';
                }
                
                username += `_${nisn.slice(-4)}`;

                // Generate password
                const birth = new Date(birthDate);
                const year = birth.getFullYear().toString().slice(-2);
                const month = (birth.getMonth() + 1).toString().padStart(2, '0');
                const day = birth.getDate().toString().padStart(2, '0');
                let password = `TKA13${year}${month}${day}`;
                
                // Add random suffix
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
                const suffix = chars.slice(0, 2).split('').map(char => 
                    chars.charAt(Math.floor(Math.random() * chars.length))
                ).join('');
                password += suffix;

                // Generate participant ID
                const participantId = `TKA13-${Date.now().toString().slice(-3).padStart(3, '0')}`;

                return { username, password, participantId };
            }

            validateForm() {
                const requiredFields = ['fullName', 'nisn', 'birthDate'];
                let isValid = true;

                requiredFields.forEach(fieldName => {
                    const field = document.getElementById(fieldName);
                    if (!this.validateField(field)) {
                        isValid = false;
                    }
                });

                // Check duplicate NISN
                if (isValid && this.checkNisnDuplicate()) {
                    isValid = false;
                }

                return isValid;
            }

            async handleSubmit(saveAndContinue = false) {
                if (!this.validateForm()) {
                    this.showAlert('error', 'Mohon periksa kembali data yang diisi');
                    return;
                }

                const formData = {
                    fullName: document.getElementById('fullName').value.trim(),
                    nisn: document.getElementById('nisn').value.trim(),
                    birthDate: document.getElementById('birthDate').value,
                    ...this.generateCredentials(
                        document.getElementById('fullName').value.trim(),
                        document.getElementById('nisn').value.trim(),
                        document.getElementById('birthDate').value
                    )
                };

                try {
                    this.showLoading(true);
                    
                    const response = await axios.post('/api/participants', formData);
                    
                    if (response.data.success) {
                        this.showAlert('success', 'Peserta berhasil ditambahkan!');
                        
                        if (saveAndContinue) {
                            this.resetForm();
                        } else {
                            this.showSuccessMessage();
                        }
                        
                        // Refresh existing data
                        await this.loadExistingData();
                    } else {
                        throw new Error(response.data.message || 'Gagal menyimpan data');
                    }
                    
                } catch (error) {
                    console.error('Error saving participant:', error);
                    this.showAlert('error', error.response?.data?.message || 'Terjadi kesalahan saat menyimpan data');
                } finally {
                    this.showLoading(false);
                }
            }

            resetForm() {
                this.form.reset();
                this.clearAllErrors();
                document.getElementById('credentialsDisplay').style.display = 'none';
                document.getElementById('ageInfo').textContent = '';
            }

            clearAllErrors() {
                const errorElements = document.querySelectorAll('.validation-feedback');
                errorElements.forEach(el => el.textContent = '');
                
                const invalidFields = document.querySelectorAll('.is-invalid');
                invalidFields.forEach(field => field.classList.remove('is-invalid'));
                
                const duplicateWarning = document.getElementById('nisnDuplicate');
                if (duplicateWarning) {
                    duplicateWarning.style.display = 'none';
                }
            }

            showLoading(show) {
                const overlay = document.getElementById('loadingOverlay');
                const submitBtn = document.getElementById('submitBtn');
                
                if (show) {
                    overlay.style.display = 'flex';
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Menyimpan...';
                } else {
                    overlay.style.display = 'none';
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="bi bi-save"></i> Simpan Peserta';
                }
            }

            showSuccessMessage() {
                document.getElementById('successMessage').style.display = 'block';
                document.getElementById('participantForm').style.display = 'none';
                
                // Auto redirect after 3 seconds
                setTimeout(() => {
                    window.location.href = 'participants.html';
                }, 3000);
            }

            showAlert(type, message) {
                // Create alert container if it doesn't exist
                let alertContainer = document.getElementById('alertContainer');
                if (!alertContainer) {
                    alertContainer = document.createElement('div');
                    alertContainer.id = 'alertContainer';
                    alertContainer.className = 'position-fixed top-0 start-50 translate-middle-x';
                    alertContainer.style.zIndex = '9999';
                    document.body.appendChild(alertContainer);
                }
                
                const alertClass = type === 'error' ? 'danger' : 'success';
                const icon = type === 'error' ? 'exclamation-triangle' : 'check-circle';
                
                alertContainer.innerHTML = `
                    <div class="alert alert-${alertClass} alert-dismissible fade show" role="alert" style="min-width: 350px;">
                        <i class="bi bi-${icon}-fill me-2"></i>
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
                
                setTimeout(() => {
                    const alert = alertContainer.querySelector('.alert');
                    if (alert) {
                        const bsAlert = new bootstrap.Alert(alert);
                        bsAlert.close();
                    }
                }, 5000);
            }
        }

        // Global functions
        function resetForm() {
            if (window.participantFormManager) {
                window.participantFormManager.resetForm();
            }
        }

        function saveAndContinue() {
            if (window.participantFormManager) {
                window.participantFormManager.handleSubmit(true);
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            window.participantFormManager = new ParticipantFormManager();
        });
    </script>

    <style>
        /* Additional styles for this page */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-content {
            background: white;
            padding: 3rem;
            border-radius: 1rem;
            text-align: center;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.3);
        }

        .page-header {
            background: linear-gradient(135deg, #0d6efd 0%, #6610f2 100%);
            color: white;
            padding: 3rem 0;
            margin-bottom: 2rem;
        }

        .breadcrumb-item a {
            color: rgba(255, 255, 255, 0.8);
        }

        .breadcrumb-item.active {
            color: white;
        }
    </style>
</body>
</html>